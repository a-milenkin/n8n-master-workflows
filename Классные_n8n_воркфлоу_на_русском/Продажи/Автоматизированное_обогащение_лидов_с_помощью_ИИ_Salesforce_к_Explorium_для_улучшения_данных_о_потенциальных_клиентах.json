{
  "id": "u92uqa8glb0TuCG9",
  "meta": {
    "instanceId": "0a70652f43c1b29dd16c35b61a38fd31c8004f58bc7e723bf43262a797407c77",
    "templateCredsSetupCompleted": true
  },
  "name": "Salesforce с 2 обогащениями потенциальных клиентов - финал",
  "tags": [],
  "nodes": [
    {
      "id": "70a40c85-eb5d-41b0-96ab-11ba442189c8",
      "name": "Salesforce Trigger",
      "type": "n8n-nodes-base.salesforceTrigger",
      "position": [
        -1880,
        680
      ],
      "parameters": {
        "pollTimes": {
          "item": [
            {
              "mode": "everyMinute"
            }
          ]
        },
        "triggerOn": "leadCreated"
      },
      "credentials": {
        "salesforceOAuth2Api": {
          "id": "unhmsSbB64eNwCMO",
          "name": "Salesforce account"
        }
      },
      "typeVersion": 1
    },
    {
      "id": "b16d1538-753a-405f-884c-c05dd1076c15",
      "name": "Update Lead",
      "type": "n8n-nodes-base.salesforce",
      "position": [
        -340,
        680
      ],
      "parameters": {
        "leadId": "={{ $('Salesforce Trigger').item.json.Id}}",
        "operation": "update",
        "updateFields": {
          "city": "={{ $json.city || null }}",
          "email": "={{ $json.professions_email || null }}",
          "phone": "={{ $json.phone_numbers?.[0]?.phone_number || \"null\" }}\n",
          "state": "={{ $json.region_name || '' }}",
          "title": "={{ $json.experience?.[0]?.title?.name || null }}",
          "company": "={{ $json.company_name || null }}",
          "country": "={{ $json.country_name || null }}",
          "website": "={{ $json.experience?.[0]?.company?.website || null }}",
          "mobilePhone": "={{ $json.mobile_phone }}"
        }
      },
      "credentials": {
        "salesforceOAuth2Api": {
          "id": "unhmsSbB64eNwCMO",
          "name": "Salesforce account"
        }
      },
      "typeVersion": 1
    },
    {
      "id": "5417925f-919e-4c44-ba21-9249cab895eb",
      "name": "Match_prospect",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        -1660,
        680
      ],
      "parameters": {
        "url": "https://api.explorium.ai/v1/prospects/match",
        "method": "POST",
        "options": {},
        "jsonBody": "={\n  \"prospects_to_match\": [\n    {\n      \"full_name\": \"{{ $('Salesforce Trigger').item.json.FirstName }} {{ $('Salesforce Trigger').item.json.LastName }}\",\n      \"company_name\": \"{{ $('Salesforce Trigger').item.json.Company }}\"\n    }\n  ]\n}",
        "sendBody": true,
        "jsonHeaders": "{\n  \"Content-Type\": \"application/json\",\n  \"Accept\": \"application/json\"\n}",
        "sendHeaders": true,
        "specifyBody": "json",
        "authentication": "genericCredentialType",
        "specifyHeaders": "json",
        "genericAuthType": "httpHeaderAuth"
      },
      "credentials": {
        "httpHeaderAuth": {
          "id": "85mkGmNNdK1951hF",
          "name": "Header Auth Connection"
        }
      },
      "typeVersion": 4.2
    },
    {
      "id": "360ca1d3-c1e6-46f4-b190-ddf76ed8847b",
      "name": "Extract Prospect IDs from Matched Results",
      "type": "n8n-nodes-base.code",
      "position": [
        -1220,
        680
      ],
      "parameters": {
        "jsCode": "const allItems = $input.all();\nconst prospectIds = allItems.map(item => \n  item.json.matched_prospects.map(prospect => prospect.prospect_id)\n).flat();\n\nreturn [{\n  json: {\n    prospect_ids: prospectIds\n  }\n}];"
      },
      "typeVersion": 2
    },
    {
      "id": "aa419a45-dae1-47b0-8030-5fe0e193f804",
      "name": "Explorium Enrich Contacts Information",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        -1000,
        580
      ],
      "parameters": {
        "url": "https://api.explorium.ai/v1/prospects/contacts_information/bulk_enrich",
        "method": "POST",
        "options": {},
        "jsonBody": "={{ { \"prospect_ids\": $json.prospect_ids } }}",
        "sendBody": true,
        "jsonHeaders": "{\n  \"Content-Type\": \"application/json\",\n  \"Accept\": \"application/json\"\n}",
        "sendHeaders": true,
        "specifyBody": "=json",
        "authentication": "genericCredentialType",
        "bodyParameters": {
          "parameters": [
            {}
          ]
        },
        "specifyHeaders": "json",
        "genericAuthType": "httpHeaderAuth"
      },
      "credentials": {
        "httpHeaderAuth": {
          "id": "85mkGmNNdK1951hF",
          "name": "Header Auth Connection"
        }
      },
      "typeVersion": 4.2
    },
    {
      "id": "91bfa198-cecf-406f-94d8-1433a75e0ada",
      "name": "Merge",
      "type": "n8n-nodes-base.merge",
      "position": [
        -780,
        680
      ],
      "parameters": {
        "mode": "combine",
        "options": {},
        "fieldsToMatchString": "data[0].prospect_id"
      },
      "typeVersion": 3.1
    },
    {
      "id": "7d7866ec-8839-48c4-9dd7-239844dfb207",
      "name": "Filter non-matched",
      "type": "n8n-nodes-base.filter",
      "position": [
        -1440,
        680
      ],
      "parameters": {
        "options": {},
        "conditions": {
          "options": {
            "version": 2,
            "leftValue": "",
            "caseSensitive": true,
            "typeValidation": "strict"
          },
          "combinator": "and",
          "conditions": [
            {
              "id": "6896e951-8d66-41b1-87a5-a96d2e049675",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              },
              "leftValue": "={{ $json.matched_prospects.some(prospect => prospect.prospect_id !== null).toBoolean() }}",
              "rightValue": "null"
            }
          ]
        }
      },
      "typeVersion": 2.2
    },
    {
      "id": "b67d5f83-2ba9-4c78-84ff-0a94382788f8",
      "name": "Code - flatten",
      "type": "n8n-nodes-base.code",
      "position": [
        -560,
        680
      ],
      "parameters": {
        "jsCode": "return $input.all().map(item => \n    item.json.data.map(prospect => ({\n      prospect_id: prospect.prospect_id,\n      ...prospect.data\n    }))\n  ).flat()"
      },
      "typeVersion": 2
    },
    {
      "id": "96abf132-7d7e-4e91-89da-5f0b373385a9",
      "name": "Explorium Enrich Profiles",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        -1000,
        780
      ],
      "parameters": {
        "url": "https://api.explorium.ai/v1/prospects/profiles/bulk_enrich",
        "method": "POST",
        "options": {},
        "jsonBody": "={{ { \"prospect_ids\": $json.prospect_ids } }}",
        "sendBody": true,
        "jsonHeaders": "{\n  \"Content-Type\": \"application/json\",\n  \"Accept\": \"application/json\"\n}",
        "sendHeaders": true,
        "specifyBody": "=json",
        "authentication": "genericCredentialType",
        "bodyParameters": {
          "parameters": [
            {}
          ]
        },
        "specifyHeaders": "json",
        "genericAuthType": "httpHeaderAuth"
      },
      "credentials": {
        "httpHeaderAuth": {
          "id": "85mkGmNNdK1951hF",
          "name": "Header Auth Connection"
        }
      },
      "typeVersion": 4.2
    },
    {
      "id": "6c17ea6e-165f-407a-b4c9-8731d44243f8",
      "name": "Sticky Note",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -2760,
        480
      ],
      "parameters": {
        "width": 760,
        "height": 2720,
        "content": "# Автоматическое обогащение лидов в Salesforce с использованием Explorium MCP\n\nЭтот рабочий процесс n8n упрощает процесс обогащения информации о лидах, автоматически обнаруживая новые лиды, созданные в Salesforce, обрабатывая их с помощью инструментов на базе ИИ от Explorium и обновляя те же лиды обратно в Salesforce с улучшенными данными о потенциальных клиентах.\n\n## Необходимые учетные данные\n\nЧтобы использовать этот рабочий процесс, настройте следующие учетные данные в вашей среде n8n:\n\n### Salesforce\n- **Тип**: OAuth2 или Имя пользователя/Пароль\n- **Используется для**: триггера на новые лиды, обновления записей о лидах\n\n### API Explorium\n- **Тип**: Общая аутентификация заголовка\n- **Заголовок**: Authorization\n- **Значение**: Bearer YOUR_API_KEY\n\nПерейдите в Настройки → Учетные данные, создайте эти два учетных данных и назначьте их в соответствующих узлах перед запуском рабочего процесса.\n\n## Обзор рабочего процесса\n\n### Узел 1: Триггер Salesforce\nЭтот узел слушает события в реальном времени от подключенной учетной записи Salesforce, в частности, отслеживает события создания новых лидов.\n\n- **Событие**: leadCreated\n- **Тип триггера**: Вебхук в реальном времени\n\nПосле срабатывания узел передает метаданные о вновь созданном лиде на следующий шаг в потоке.\n\n### Узел 2: Match_prospect\nЭтот узел отправляет данные лида в API сопоставления потенциальных клиентов на базе ИИ от Explorium в реальном времени.\n\n- **Метод**: POST\n- **Конечная точка**: https://api.explorium.ai/v1/prospects/match\n- **Аутентификация**: Общая аутентификация заголовка (с использованием настроенных учетных данных)\n- **Заголовки**: Content-Type: application/json\n\nТело запроса динамически формируется из данных о лиде, обычно включая: full_name, company_name, email, phone_number, linkedin. Эти поля сопоставляются с интеллект-графом Explorium для возврата обогащенных или проверенных профилей.\n\n**Выходной ответ**: total_matches, matched_prospects и prospect_id. Каждый ответ используется в дальнейшем для обогащения и обновления информации о лиде.\n\n### Узел 3: Фильтр несопоставленных\nЭтот узел фильтрует выходные данные из шага Match_prospect, чтобы гарантировать, что только действительные, сопоставленные результаты продолжают движение по потоку. Только записи, содержащие хотя бы одного сопоставленного потенциального клиента с ненулевым prospect_id, передаются дальше.\n\n**Логика фильтрации**: Оставляет только лиды, у которых есть успешные сопоставления потенциальных клиентов от Explorium\n\n### Узел 4: Извлечение идентификаторов потенциальных клиентов из сопоставленных результатов\nЭтот узел извлекает все действительные значения prospect_id из ранее сопоставленных потенциальных клиентов и компилирует их в плоский массив. Он проходит по всем сопоставленным элементам, извлекает каждый prospect_id из массива matched_prospects и возвращает один объект с массивом всех prospect_ids.\n\n### Узел 5: Explorium Обогащение информации о контактах\nЭтот узел выполняет массовое обогащение контактов, запрашивая Explorium с помощью списка сопоставленных prospect_ids.\n\n**Конфигурация узла:**\n- **Метод**: POST\n- **Конечная точка**: https://api.explorium.ai/v1/prospects/contacts_information/bulk_enrich\n- **Аутентификация**: Аутентификация заголовка (с использованием сохраненных учетных данных)\n- **Заголовки**: \"Content-Type\": \"application/json\", \"Accept\": \"application/json\"\n\nВозвращает обогащенную информацию о контактах, такую как:\n- **emails**: профессиональные/личные адреса электронной почты\n- **phone_numbers**: мобильные и рабочие номера\n- **professions_email**, **professional_email_status**, **mobile_phone**\n\n### Узел 6: Explorium Обогащение профилей\nЭтот дополнительный узел обогащения предоставляет дополнительное улучшение данных о контактах, работая параллельно с основным процессом обогащения, чтобы максимизировать сбор данных с различных конечных точек Explorium.\n\n### Узел 7: Объединение\nЭтот узел объединяет несколько потоков данных из параллельных процессов обогащения в один выход, позволяя вам консолидировать данные из различных конечных точек обогащения Explorium. Настройка \"combine\" указывает на то, что он будет объединять входящие потоки данных, а не перезаписывать их.\n\n### Узел 8: Код - упрощение\nЭтот пользовательский код узел обрабатывает и преобразует объединенные данные обогащения перед обновлением лида в Salesforce. Его можно использовать для:\n- Упрощения вложенных структур данных из ответов Explorium\n- Форматирования данных в соответствии с требованиями полей Salesforce\n- Применения бизнес-логики или валидации данных\n- Сопоставления полей Explorium с свойствами лида Salesforce\n- Обработки преобразований типов данных и нулевых значений\n\n### Узел 9: Обновление лида\nЭтот последний узел обновляет оригинальный лид в Salesforce, используя обогащенные данные, возвращенные Explorium.\n\n- **Учетные данные**: Salesforce OAuth2 или Имя пользователя/Пароль\n- **Ресурс**: Лид\n- **Операция**: Обновить лид\n\nУзел обновляет существующую запись лида обогащенной информацией, включая дополнительные контактные данные, профессиональные данные и улучшенную информацию о компании, полученную в процессе обогащения от Explorium.\n\n## Резюме потока рабочего процесса\n\n1. **Триггер**: Вебхук Salesforce срабатывает при создании нового лида\n2. **Сопоставление**: Поиск сопоставлений потенциальных клиентов с использованием Explorium на основе данных о лиде\n3. **Фильтрация**: Оставить только успешно сопоставленные потенциальные клиенты\n4. **Извлечение**: Скомпилировать идентификаторы потенциальных клиентов для массового обогащения\n5. **Обогащение**: Параллельное обогащение информации о контактах через несколько конечных точек Explorium\n6. **Объединение**: Объединить результаты обогащения в единые данные\n7. **Преобразование**: Упрощение и подготовка данных для обновления Salesforce (код узел)\n8. **Обновление**: Обновить оригинальную запись лида в Salesforce с обогащенными данными\n\nЭтот рабочий процесс обеспечивает комплексное обогащение лидов, сохраняя качество данных и обеспечивая бесшовную интеграцию в вашей среде Salesforce. Структура параллельного обогащения максимизирует эффективность сбора данных, а фильтрация гарантирует, что обрабатываются только высококачественные совпадения, что приводит к улучшенным записям о лидах с ценными данными о потенциальных клиентах."
      },
      "typeVersion": 1
    }
  ],
  "active": false,
  "pinData": {
    "Salesforce Trigger": [
      {
        "json": {
          "Id": "00QQJ00000I7no12AB",
          "City": null,
          "Email": "vincent.marinelli@flushingsavings.com",
          "Status": "New",
          "Street": null,
          "Company": "flushingsavings",
          "LastName": "marinelli",
          "FirstName": "vincent",
          "PostalCode": null,
          "attributes": {
            "url": "/services/data/v59.0/sobjects/Lead/00QQJ00000I7no12AB",
            "type": "Lead"
          }
        }
      }
    ]
  },
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "c8a79ca0-36ce-443f-b6fc-21bfa6ade38c",
  "connections": {
    "Merge": {
      "main": [
        [
          {
            "node": "Code - flatten",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Lead": {
      "main": [
        []
      ]
    },
    "Code - flatten": {
      "main": [
        [
          {
            "node": "Update Lead",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Match_prospect": {
      "main": [
        [
          {
            "node": "Filter non-matched",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Filter non-matched": {
      "main": [
        [
          {
            "node": "Extract Prospect IDs from Matched Results",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Salesforce Trigger": {
      "main": [
        [
          {
            "node": "Match_prospect",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Explorium Enrich Profiles": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Explorium Enrich Contacts Information": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract Prospect IDs from Matched Results": {
      "main": [
        [
          {
            "node": "Explorium Enrich Contacts Information",
            "type": "main",
            "index": 0
          },
          {
            "node": "Explorium Enrich Profiles",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  }
}