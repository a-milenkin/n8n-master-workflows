{
  "id": "",
  "meta": {
    "instanceId": "",
    "templateCredsSetupCompleted": true
  },
  "name": "- Использовать изображение напрямую в n8n: В HTTP-запросе \"Сгенерировать изображение\" переключите sync_mode на \"true\", удалите все последующие узлы и добавьте узел \"Извлечь из файла\" (преобразовать в строку Base64).",
  "tags": [],
  "nodes": [
    {
      "id": "",
      "name": "When clicking ‘Execute workflow’",
      "type": "n8n-nodes-base.manualTrigger",
      "position": [
        -680,
        -180
      ],
      "parameters": {},
      "typeVersion": 1
    },
    {
      "id": "",
      "name": "Airtable",
      "type": "n8n-nodes-base.airtable",
      "position": [
        -380,
        -180
      ],
      "parameters": {
        "base": {
          "__rl": true,
          "mode": "list",
          "value": "",
          "cachedResultUrl": "https://airtable.com/",
          "cachedResultName": "YTB Outlier Finder"
        },
        "table": {
          "__rl": true,
          "mode": "list",
          "value": "",
          "cachedResultUrl": "https://airtable.com/",
          "cachedResultName": "Image Generation"
        },
        "options": {
          "fields": [
            "ImageDescription",
            "Situation",
            "BaseImage",
            "Name"
          ]
        },
        "operation": "search",
        "filterByFormula": "={Prompt} = \"\""
      },
      "credentials": {
        "airtableTokenApi": {
          "id": "",
          "name": "Airtable Personal Access Token account"
        }
      },
      "typeVersion": 2.1
    },
    {
      "id": "",
      "name": "Generate Image",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        140,
        -180
      ],
      "parameters": {
        "url": "https://fal.run/fal-ai/flux-pro/kontext/max",
        "method": "POST",
        "options": {},
        "sendBody": true,
        "sendHeaders": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "prompt",
              "value": "={{ $json.text }}"
            },
            {
              "name": "image_url",
              "value": "={{ $('Airtable').item.json.BaseImage[0].url }}"
            },
            {
              "name": "guidance_scale",
              "value": "7.5"
            },
            {
              "name": "num_images",
              "value": 1
            },
            {
              "name": "safety_tolerance",
              "value": 2
            },
            {
              "name": "output_format",
              "value": "jpeg"
            },
            {
              "name": "sync_mode",
              "value": "false"
            },
            {
              "name": "aspect_ratio",
              "value": "1:1"
            }
          ]
        },
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "=Key {{ $('Edit Fields').item.json.FalAITOKEN }}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        }
      },
      "retryOnFail": true,
      "typeVersion": 4.2
    },
    {
      "id": "",
      "name": "Log Image Posts",
      "type": "n8n-nodes-base.airtable",
      "position": [
        640,
        -200
      ],
      "parameters": {
        "base": {
          "__rl": true,
          "mode": "list",
          "value": "",
          "cachedResultUrl": "https://airtable.com/",
          "cachedResultName": "YTB Outlier Finder"
        },
        "table": {
          "__rl": true,
          "mode": "list",
          "value": "",
          "cachedResultUrl": "https://airtable.com/",
          "cachedResultName": "Table 2"
        },
        "columns": {
          "value": {
            "Name": "={{ $('Airtable').item.json.Name }}",
            "Prompt": "={{ $json.prompt }}",
            "FinalImage": "={{ [{ \"url\": $json.images[0].url}] }}"
          },
          "schema": [
            {
              "id": "Name",
              "type": "string",
              "display": true,
              "removed": false,
              "readOnly": true,
              "required": false,
              "displayName": "Name",
              "defaultMatch": false,
              "canBeUsedToMatch": true
            },
            {
              "id": "BaseImage",
              "type": "array",
              "display": true,
              "removed": true,
              "readOnly": false,
              "required": false,
              "displayName": "BaseImage",
              "defaultMatch": false,
              "canBeUsedToMatch": true
            },
            {
              "id": "ImageDescription",
              "type": "string",
              "display": true,
              "removed": true,
              "readOnly": false,
              "required": false,
              "displayName": "ImageDescription",
              "defaultMatch": false,
              "canBeUsedToMatch": true
            },
            {
              "id": "Situation",
              "type": "string",
              "display": true,
              "removed": true,
              "readOnly": false,
              "required": false,
              "displayName": "Situation",
              "defaultMatch": false,
              "canBeUsedToMatch": true
            },
            {
              "id": "Prompt",
              "type": "string",
              "display": true,
              "removed": false,
              "readOnly": false,
              "required": false,
              "displayName": "Prompt",
              "defaultMatch": false,
              "canBeUsedToMatch": true
            },
            {
              "id": "FinalImage",
              "type": "array",
              "display": true,
              "removed": false,
              "readOnly": false,
              "required": false,
              "displayName": "FinalImage",
              "defaultMatch": false,
              "canBeUsedToMatch": true
            }
          ],
          "mappingMode": "defineBelow",
          "matchingColumns": [
            "Name"
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {},
        "operation": "update"
      },
      "credentials": {
        "airtableTokenApi": {
          "id": "",
          "name": "Airtable Personal Access Token account"
        }
      },
      "typeVersion": 2.1
    },
    {
      "id": "",
      "name": "Check IF Generated",
      "type": "n8n-nodes-base.httpRequest",
      "onError": "continueErrorOutput",
      "position": [
        340,
        -180
      ],
      "parameters": {
        "url": "={{ $json.images[0].url }}",
        "options": {}
      },
      "typeVersion": 4.2
    },
    {
      "id": "",
      "name": "Wait",
      "type": "n8n-nodes-base.wait",
      "position": [
        500,
        -120
      ],
      "webhookId": "",
      "parameters": {
        "amount": 3
      },
      "typeVersion": 1.1
    },
    {
      "id": "",
      "name": "Mistral Cloud Chat Model",
      "type": "@n8n/n8n-nodes-langchain.lmChatMistralCloud",
      "position": [
        -140,
        -20
      ],
      "parameters": {
        "model": "mistral-large-latest",
        "options": {}
      },
      "credentials": {
        "mistralCloudApi": {
          "id": "",
          "name": "Mistral Cloud account"
        }
      },
      "typeVersion": 1
    },
    {
      "id": "",
      "name": "Generate Prompt",
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "position": [
        -220,
        -180
      ],
      "parameters": {
        "text": "You are a Image Generation assistant.",
        "batching": {},
        "messages": {
          "messageValues": [
            {
              "type": "HumanMessagePromptTemplate",
              "message": "=You are a creative prompt engineer specializing in generating detailed image-to-image prompts for AI models like Stable Diffusion or Leonardo AI.\n\nYou will receive:\n- A base subject :{{ $json.ImageDescription }}\n- A situation or context that must be represented visually :{{ $json.Situation }}\n\nYour task is to generate an enhanced, imaginative prompt that:\n- Incorporates the visual details from the situation.\n- Respects the base subject’s identity (i.e., the AI will transform an image of the given subject, not create a completely new one).\n- Uses scene-building language to describe environment, mood, lighting, and dynamics.\n- Mentions the style if relevant (e.g., “realistic”, “cinematic”, “fantasy illustration”, etc.).\n- Avoids over-describing the subject's core features (to preserve the base image).\n\nOutput Format:\n- One paragraph of 1–3 sentences.\n- Include keywords or phrases that guide the AI visually (e.g., “dramatic lighting”, “smoke and lava in the background”, “third-person perspective”).\n- Return ONLY the prompt that will be directly given to the Image Generation LLM.\n\nExample Input:\nSubject: “a dog”\nSituation: “the dog is climbing a volcano in eruption”\n\nExample Output Prompt:\n“A dog braving the treacherous slopes of an erupting volcano, surrounded by glowing lava streams and thick clouds of smoke. The sky is darkened with ash as fiery embers illuminate the scene. Realistic style, cinematic lighting, wide-angle perspective.”"
            }
          ]
        },
        "promptType": "define"
      },
      "typeVersion": 1.7
    },
    {
      "id": "",
      "name": "Sticky Note",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        80,
        -280
      ],
      "parameters": {
        "color": 7,
        "width": 760,
        "height": 400,
        "content": "## Генерация изображений"
      },
      "typeVersion": 1
    },
    {
      "id": "",
      "name": "Sticky Note1",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -720,
        -280
      ],
      "parameters": {
        "color": 7,
        "width": 780,
        "height": 400,
        "content": "## Исходное изображение и подсказка"
      },
      "typeVersion": 1
    },
    {
      "id": "",
      "name": "Sticky Note6",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -720,
        -700
      ],
      "parameters": {
        "color": 7,
        "width": 780,
        "height": 400,
        "content": "## НАСТРОЙКА"
      },
      "typeVersion": 1
    },
    {
      "id": "",
      "name": "Sticky Note5",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -720,
        -1200
      ],
      "parameters": {
        "color": 7,
        "width": 500,
        "height": 480,
        "content": "**Ввод настройки:** Первая часть рабочего процесса может быть заменена на что-то другое. Вам нужны входные данные: Подсказка и URL-адрес исходного изображения (доступный публично)."
      },
      "typeVersion": 1
    },
    {
      "id": "",
      "name": "Sticky Note2",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        80,
        -920
      ],
      "parameters": {
        "color": 7,
        "width": 380,
        "height": 620,
        "content": "**Вывод настройки:** В этом рабочем процессе выводом является хранение изображения в Airtable, но вы можете заменить это на что-то другое, но в основном у вас есть два варианта:"
      },
      "typeVersion": 1
    },
    {
      "id": "",
      "name": "Sticky Note3",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        480,
        -720
      ],
      "parameters": {
        "color": 7,
        "width": 360,
        "height": 420,
        "content": "- Хранить сгенерированное изображение где-то: Оставьте все как есть и замените последний узел Airtable на сторонний сервис, который вы хотите использовать."
      },
      "typeVersion": 1
    },
    {
      "id": "",
      "name": "Edit Fields",
      "type": "n8n-nodes-base.set",
      "position": [
        -520,
        -180
      ],
      "parameters": {
        "options": {},
        "assignments": {
          "assignments": [
            {
              "id": "",
              "name": "FalAITOKEN",
              "type": "string",
              "value": "[YOUR_API_TOKEN]"
            }
          ]
        }
      },
      "typeVersion": 3.4
    }
  ],
  "active": false,
  "pinData": {},
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "",
  "connections": {
    "Wait": {
      "main": [
        [
          {
            "node": "Check IF Generated",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Airtable": {
      "main": [
        [
          {
            "node": "Generate Prompt",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields": {
      "main": [
        [
          {
            "node": "Airtable",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Generate Image": {
      "main": [
        [
          {
            "node": "Check IF Generated",
            "type": "main",
            "index": 0
          }
        ],
        []
      ]
    },
    "Generate Prompt": {
      "main": [
        [
          {
            "node": "Generate Image",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check IF Generated": {
      "main": [
        [
          {
            "node": "Log Image Posts",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Wait",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Mistral Cloud Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "Generate Prompt",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "When clicking ‘Execute workflow’": {
      "main": [
        [
          {
            "node": "Edit Fields",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  }
}